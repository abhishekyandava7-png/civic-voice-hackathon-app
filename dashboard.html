<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Public Dashboard - Citizen Reporter</title>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display.swap" rel="stylesheet">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Our Custom Stylesheet -->
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-dark-gradient">

    <!-- =========== NAVBAR =========== -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="/">Citizen Reporter</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Submit Report</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/dashboard">View All Reports</a>
                    </li>
                    <!-- ADD THIS LINK BACK -->
                    <li class="nav-item">
                        <a class="nav-link" href="/?view=status">Check Status</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- =========== MAIN CONTENT =========== -->
    <div class="container">
        
        <!-- --- Page Title --- -->
        <h1 class="text-light text-center my-4" style="font-weight: 700;">Public Reports Dashboard</h1>

        <!-- --- Sorting Controls --- -->
        <div class="card card-dark-bg p-3 mb-4">
            <div class="row g-3 align-items-center">
                <div class="col-md-3">
                    <label for="sort-by" class="form-label">Sort By:</label>
                </div>
                <div class="col-md-9">
                    <select id="sort-by" class="form-select form-control-dark">
                        <option value="priority">Priority (Highest First)</option>
                        <option value="status">Status</option>
                        <option value="ministry">Ministry / Dept.</option>
                        <option value="type">Problem Type</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- --- Report List (Table View) --- -->
        <div id="report-table-container" style="display: none;">
            <table class="table table-dark table-hover align-middle">
                <thead>
                    <tr>
                        <th scope="col">Priority</th>
                        <th scope="col">Status</th>
                        <th scope="col">Votes</th>
                        <th scope="col">Problem Type</th>
                        <th scope="col">Ministry/Dept</th>
                        <th scope="col">Description</th>
                        <th scope="col">Filed On</th>
                    </tr>
                </thead>
                <tbody id="report-table-body">
                    <!-- Rows will be injected here -->
                </tbody>
            </table>
        </div>

        <!-- Loading Spinner -->
        <div id="loading-spinner" class="text-center text-light mt-5">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Fetching all reports...</p>
        </div>

    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- =========== OUR APP JAVASCRIPT =========== -->
    <script>
        let allReports = []; // Master list of reports
        const reportTableBody = document.getElementById('report-table-body');
        const reportTableContainer = document.getElementById('report-table-container');
        const sortDropdown = document.getElementById('sort-by');
        const loadingSpinner = document.getElementById('loading-spinner');
        const VOTED_KEY = 'voted-reports'; // localStorage key

        // --- 1. Fetch data when page loads ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchReports();
            sortDropdown.addEventListener('change', renderReports);
            reportTableBody.addEventListener('click', handleVoteClick);
        });

        async function fetchReports() {
            try {
                const response = await fetch('/get-all-reports');
                if (!response.ok) throw new Error('Failed to fetch reports.');
                
                const reports = await response.json();
                
                // Process reports: calculate priority
                allReports = reports.map(report => {
                    const priority = calculatePriority(report);
                    return { ...report, priority, dateObject: new Date(report.timestamp) };
                });

                renderReports();

            } catch (error) {
                console.error(error);
                loadingSpinner.innerHTML = `<div class="alert alert-danger">Error loading reports. Please try again later.</div>`;
            }
        }

        // --- 2. Calculate Priority (Dynamic) ---
        function calculatePriority(report) {
            const reportDate = new Date(report.timestamp);
            const now = new Date();
            const diffTime = Math.abs(now - reportDate);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            // Priority is 1 point per day + votes
            const votes = report.votes || 0;
            const priorityScore = (report.status === 'Completed') ? -1 : diffDays + votes;

            let level = 'Low';
            let badgeClass = 'bg-secondary-subtle text-secondary-emphasis';

            // Determine priority level
            if (priorityScore > 20) {
                level = 'High';
                badgeClass = 'bg-danger-subtle text-danger-emphasis';
            } else if (priorityScore > 7) {
                level = 'Medium';
                badgeClass = 'bg-warning-subtle text-warning-emphasis';
            }
            
            if (report.status === 'Completed') {
                level = 'Done';
                badgeClass = 'bg-success-subtle text-success-emphasis';
            }

            return { score: priorityScore, text: `${level} (${priorityScore} Pts)`, badgeClass };
        }

        // --- 3. Render and Sort Reports (UPDATED) ---
        function renderReports() {
            loadingSpinner.style.display = 'none'; // Hide loading spinner
            reportTableContainer.style.display = 'block'; // Show the table
            reportTableBody.innerHTML = ''; // Clear the table body

            const sortBy = sortDropdown.value;
            const votedReports = JSON.parse(localStorage.getItem(VOTED_KEY)) || [];

            let reportsToRender = [...allReports];

            // Sort the array
            switch (sortBy) {
                case 'priority':
                    // Sort by priority score (Highest first)
                    reportsToRender.sort((a, b) => b.priority.score - a.priority.score); 
                    break;
                case 'status':
                    reportsToRender.sort((a, b) => a.status.localeCompare(b.status));
                    break;
                case 'ministry':
                    reportsToRender.sort((a, b) => a.institution.localeCompare(b.institution));
                    break;
                case 'type':
                    reportsToRender.sort((a, b) => a.problemType.localeCompare(b.problemType));
                    break;
            }

            if (reportsToRender.length === 0) {
                reportTableBody.innerHTML = `<tr><td colspan="7" class="text-center text-light">No reports found.</td></tr>`;
                return;
            }

            // Generate HTML for each report row
            reportsToRender.forEach(report => {
                const truncatedDesc = report.description.length > 50 
                    ? report.description.substring(0, 50) + '...' 
                    : report.description;
                
                const hasVoted = votedReports.includes(report.id);
                const isDisabled = hasVoted || report.status === 'Completed';
                
                const voteButton = `
                    <button class="btn btn-vote btn-sm" data-id="${report.id}" ${isDisabled ? 'disabled' : ''}>
                        ${hasVoted ? 'Voted' : 'Vote'}
                    </button>
                `;

                const reportRow = `
                    <tr>
                        <td>
                            <span class="badge ${report.priority.badgeClass} rounded-pill">
                                ${report.priority.text}
                            </span>
                        </td>
                        <td>
                            <span class="badge ${report.status === 'Completed' ? 'bg-success-subtle text-success-emphasis' : 'bg-primary-subtle text-primary-emphasis'} rounded-pill">
                                ${report.status}
                            </span>
                        </td>
                        <td>
                            <span class="vote-count">${report.votes || 0}</span> ${voteButton}
                        </td>
                        <td>${report.problemType}</td>
                        <td>${report.institution}</td>
                        <td title="${report.description}">${truncatedDesc}</td>
                        <td>${report.dateObject.toLocaleString()}</td>
                    </tr>
                `;
                reportTableBody.innerHTML += reportRow;
            });
        }

        // --- 4. Handle Voting ---
        function handleVoteClick(e) {
            if (e.target.classList.contains('btn-vote')) {
                const button = e.target;
                const id = button.dataset.id;
                voteOnReport(id, button);
            }
        }

        async function voteOnReport(id, button) {
            button.disabled = true;
            button.innerHTML = '...';

            try {
                const response = await fetch(`/vote/${id}`, { method: 'POST' });
                if (!response.ok) throw new Error('Vote failed');
                
                // Add to local storage
                const votedReports = JSON.parse(localStorage.getItem(VOTED_KEY)) || [];
                votedReports.push(id);
                localStorage.setItem(VOTED_KEY, JSON.stringify(votedReports));

                // Update the master list
                const reportIndex = allReports.findIndex(r => r.id === id);
                if (reportIndex > -1) {
                    allReports[reportIndex].votes = (allReports[reportIndex].votes || 0) + 1;
                    // Recalculate priority
                    allReports[reportIndex].priority = calculatePriority(allReports[reportIndex]);
                }

                // Re-render the whole table with new priority & vote count
                renderReports();

            } catch (error) {
                console.error(error);
                button.innerHTML = 'Error';
                // Don't re-enable, to prevent spamming a failed request
            }
        }

    </script>
</body>
</html>
