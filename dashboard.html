<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Public Dashboard - Citizen Reporter</title>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Our Custom Stylesheet -->
    <link rel="stylesheet" href="public/style.css">
</head>
<body class="bg-dark-gradient">

    <!-- =========== NAVBAR =========== -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="/">Citizen Reporter</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Submit Report</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/dashboard">View All Reports</a>
                    </li>
                    <!-- --- UPDATED LINK --- -->
                    <li class="nav-item">
                        <a class="nav-link" href="/?view=status">Check Status</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- =========== MAIN CONTENT =========== -->
    <div class="container">
        
        <h1 class="text-light text-center my-4" style="font-weight: 700;">Public Reports Dashboard</h1>

        <!-- --- Sorting Controls --- -->
        <div class="card card-dark-bg p-3 mb-4">
            <div class="row g-3 align-items-center">
                <div class="col-md-3">
                    <label for="sort-by" class="form-label">Sort By:</label>
                </div>
                <div class="col-md-9">
                    <select id="sort-by" class="form-select form-control-dark">
                        <option value="priority">Priority (Oldest First)</option>
                        <option value="votes">Most Voted</option>
                        <option value="status">Status</option>
                        <option value="ministry">Ministry / Dept.</option>
                        <option value="type">Problem Type</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- --- Report List --- -->
        <div id="report-list-container" class="pb-5">
            <!-- Loading Spinner -->
            <div id="loading-spinner" class="text-center text-light mt-5">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Fetching all reports...</p>
            </div>
            
            <!-- Table will be injected here -->
            <div class="table-responsive">
                <table class="table table-dark-custom align-middle">
                    <thead>
                        <tr>
                            <th scope="col">Priority</th>
                            <th scope="col">Report</th>
                            <th scope="col">Status</th>
                            <th scope="col">Votes</th>
                            <th scope="col"></th>
                        </tr>
                    </thead>
                    <tbody id="report-list-body">
                        <!-- Report rows will be injected here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- =========== OUR APP JAVASCRIPT =========== -->
    <script>
        let allReports = []; // Master list of reports
        const reportListBody = document.getElementById('report-list-body');
        const sortDropdown = document.getElementById('sort-by');
        const loadingSpinner = document.getElementById('loading-spinner');

        // --- 1. Fetch data when page loads ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchReports();
            sortDropdown.addEventListener('change', renderReports);
            // Add click listener to the table body for event delegation
            reportListBody.addEventListener('click', handleVoteClick);
        });

        async function fetchReports() {
            try {
                const response = await fetch('/get-all-reports');
                if (!response.ok) throw new Error('Failed to fetch reports.');
                
                const reports = await response.json();
                
                // Process reports: calculate priority
                allReports = reports.map(report => {
                    const priority = calculatePriority(report.timestamp);
                    const dateObject = new Date(report.timestamp);
                    return { ...report, priority, dateObject };
                });

                renderReports();

            } catch (error) {
                console.error(error);
                loadingSpinner.innerHTML = `<div class="alert alert-danger">Error loading reports. Please try again later.</div>`;
            }
        }

        // --- 2. Calculate Priority (with hour/minute logic) ---
        function calculatePriority(isoTimestamp) {
            const reportDate = new Date(isoTimestamp);
            const now = new Date();
            const diffMs = now - reportDate; // Difference in milliseconds

            const diffMins = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24)); // Use floor

            let level = 'Low';
            let badgeClass = 'bg-secondary-subtle text-secondary-emphasis';
            let text = `${diffDays} days old`;

            if (diffDays > 14) {
                level = 'High';
                badgeClass = 'bg-danger-subtle text-danger-emphasis';
            } else if (diffDays > 7) {
                level = 'Medium';
                badgeClass = 'bg-warning-subtle text-warning-emphasis';
            }

            // Granular text for new reports
            if (diffDays < 1) {
                if (diffHours < 1) {
                    text = `${diffMins} mins old`;
                } else {
                    text = `${diffHours} hours old`;
                }
            }

            return { value: diffMs, level, badgeClass, text }; // Use milliseconds for sorting
        }

        // --- 3. Render and Sort Reports ---
        function renderReports() {
            loadingSpinner.style.display = 'none'; 
            reportListBody.innerHTML = ''; // Clear the table body

            const sortBy = sortDropdown.value;
            let reportsToRender = [...allReports];

            // Sort the array
            switch (sortBy) {
                case 'priority':
                    reportsToRender.sort((a, b) => b.priority.value - a.priority.value); // Highest ms (oldest) first
                    break;
                case 'votes':
                    reportsToRender.sort((a, b) => b.votes - a.votes); // Highest votes first
                    break;
                case 'status':
                    reportsToRender.sort((a, b) => a.status.localeCompare(b.status));
                    break;
                case 'ministry':
                    reportsToRender.sort((a, b) => a.institution.localeCompare(b.institution));
                    break;
                case 'type':
                    reportsToRender.sort((a, b) => a.problemType.localeCompare(b.problemType));
                    break;
            }

            if (reportsToRender.length === 0) {
                reportListBody.innerHTML = `<tr><td colspan="5" class="text-center text-light">No reports found.</td></tr>`;
                return;
            }

            // Generate HTML for each report row
            reportsToRender.forEach(report => {
                const statusBadge = report.status === 'Completed' 
                    ? 'bg-success' : 'bg-primary';
                
                const row = `
                    <tr>
                        <td>
                            <span class="badge ${report.priority.badgeClass} rounded-pill">
                                ${report.priority.level} (${report.priority.text})
                            </span>
                        </td>
                        <td>
                            <strong class="text-light">${report.problemType}</strong>
                            <small class="d-block text-light-emphasis">
                                Dept: ${report.institution} | Filed: ${report.dateObject.toLocaleString()}
                            </small>
                        </td>
                        <td>
                            <span class="badge ${statusBadge} rounded-pill">${report.status}</span>
                        </td>
                        <td>
                            <strong class="text-light" id="votes-${report.id}">${report.votes}</strong>
                        </td>
                        <td>
                            <button class="btn btn-vote btn-sm" data-id="${report.id}" ${report.status === 'Completed' ? 'disabled' : ''}>
                                Vote
                            </button>
                        </td>
                    </tr>
                `;
                reportListBody.innerHTML += row;
            });
        }

        // --- 4. Handle Vote Click ---
        async function handleVoteClick(e) {
            // Check if the clicked element is a vote button
            if (!e.target.classList.contains('btn-vote')) {
                return;
            }

            const button = e.target;
            const reportId = button.dataset.id;
            
            button.disabled = true;
            button.textContent = '...';

            try {
                const response = await fetch(`/vote/${reportId}`, { method: 'POST' });
                if (!response.ok) throw new Error('Vote failed');

                // Update the vote count on the page
                const voteCountElement = document.getElementById(`votes-${reportId}`);
                let currentVotes = parseInt(voteCountElement.textContent);
                voteCountElement.textContent = currentVotes + 1;
                
                button.textContent = 'Voted!';
                
                // Update the master array
                const reportInArray = allReports.find(r => r.id === reportId);
                if (reportInArray) reportInArray.votes++;

            } catch (error) {
                console.error('Vote error:', error);
                button.disabled = false;
                button.textContent = 'Vote';
            }
        }

    </script>
</body>
</html>

